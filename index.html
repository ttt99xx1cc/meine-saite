<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ink downloader v7</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Roboto:wght@300&display=swap');

    body {
      margin: 0; min-height: 100vh;
      background: linear-gradient(-45deg, #000, #0f001f, #000033, #1a0033);
      background-size: 400% 400%;
      animation: g 20s ease infinite;
      color: white; font-family: 'Roboto', sans-serif;
      display: flex; flex-direction: column; justify-content: space-between;
      padding: 20px; box-sizing: border-box;
    }
    @keyframes g { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    .c { max-width: 520px; margin: 0 auto; text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
    h1 { font-family: 'Orbitron', sans-serif; font-size: 2.8rem; margin-bottom: 8px;
         background: linear-gradient(90deg, #ff00aa, #00ffff, #ff00aa);
         -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    p { opacity: 0.9; margin-bottom: 40px; font-size: 1.1rem; }

    input { width: 100%; padding: 18px; font-size: 1.1rem; border: none; border-radius: 16px;
            background: rgba(255,255,255,0.08); color: white; margin-bottom: 25px; outline: none;
            backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    input::placeholder { color: rgba(255,255,255,0.5); }

    button { padding: 18px 40px; font-size: 1.2rem; font-weight: bold;
             background: linear-gradient(45deg, #ff006e, #ff3399); color: white; border: none;
             border-radius: 50px; cursor: pointer; box-shadow: 0 10px 30px rgba(255,0,110,0.5);
             transition: all 0.3s; }
    button:hover { transform: translateY(-4px); box-shadow: 0 15px 40px rgba(255,0,110,0.7); }

    #status { margin-top: 25px; font-size: 1rem; min-height: 30px; }

    footer { text-align: center; padding: 30px 0; font-size: 1.1rem; }
    footer a { color: #ff3399; text-decoration: none; font-weight: bold; }

    @media (max-width: 600px) { h1{font-size:2.3rem} }
  </style>
</head>
<body>

  <div class="c">
    <h1>ink downloader v7</h1>
    <p>Spotify • SoundCloud<br>Улучшенный fallback — качает через YouTube, без молчания</p>

    <input type="text" id="url" placeholder="https://open.spotify.com/track/... или https://soundcloud.com/..." />
    <button onclick="go()">СКАЧАТЬ ФАЙЛОМ</button>
    <div id="status"></div>
  </div>

  <footer>
    made by <a href="https://t.me/inkv1zator" target="_blank">@inkv1zator</a> ❤️
  </footer>

  <script>
    async function go() {
      const url = document.getElementById('url').value.trim();
      const s = document.getElementById('status');
      if (!url) { s.innerHTML = 'Вставь ссылку!'; return; }

      s.innerHTML = 'Ищем трек...';

      let apiUrl = '';
      let trackId = '';
      let query = '';

      if (url.includes('spotify.com/track/')) {
        trackId = url.split('/track/')[1].split('?')[0];
        // Новый API: spotiflyer-public (отдаёт MP3 напрямую)
        apiUrl = `https://api.spotiflyer.workers.dev/download/${trackId}`;
        query = `spotify ${trackId}`; // Для fallback
      } else if (url.includes('soundcloud.com/')) {
        trackId = url.split('/').pop().split('?')[0];
        apiUrl = `https://api.soundcloud.com/tracks/${trackId}/stream?client_id=IiZ62aLI9y0m8QvO2nF5zQ`;
        query = url.split('/').slice(-2).join(' '); // Название для YT
      } else {
        s.innerHTML = 'Только Spotify и SoundCloud!';
        return;
      }

      try {
        const r = await fetch(apiUrl);
        if (!r.ok) throw new Error('Не отвечает');

        const blob = await r.blob();
        if (blob.size < 10000) throw new Error('Трек не найден');

        const dl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = dl;
        a.download = r.headers.get('content-disposition')?.match(/filename="?(.+)"?/)?.[1] || `track_${trackId}.mp3`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(dl);
        s.innerHTML = 'Скачано! ❤️';
        setTimeout(() => s.innerHTML = '', 4000);

      } catch (e) {
        // Новый fallback: Поиск в YT + y2mate API (отдаёт MP3)
        s.innerHTML = 'Пробуем через YouTube...';
        const ytSearch = `https://www.youtube.com/results?search_query=${encodeURIComponent(query + ' full song')}`;
        const y2mateApi = `https://www.y2mate.com/mates/analyze/ajax?url=${encodeURIComponent(ytSearch)}&q=${encodeURIComponent(query)}&ftype=mp3_320&fquality=320`;

        try {
          const yr = await fetch(y2mateApi);
          const ydata = await yr.json();
          if (ydata.status === 'success' && ydata.links?.mp3) {
            const finalUrl = ydata.links.mp3[0].dlink || ydata.links.mp3;
            const fr = await fetch(finalUrl);
            const fb = await fr.blob();
            const fdl = window.URL.createObjectURL(fb);
            const fa = document.createElement('a');
            fa.href = fdl;
            fa.download = `${query.replace(/[^a-z0-9]/gi, '_')}.mp3`;
            document.body.appendChild(fa);
            fa.click();
            document.body.removeChild(fa);
            window.URL.revokeObjectURL(fdl);
            s.innerHTML = 'Скачано через YouTube! ❤️';
          } else {
            throw new Error('Не найден в YT');
          }
        } catch (fe) {
          s.innerHTML = 'Ошибка: попробуй публичный трек или другую ссылку<br>Напиши @inkv1zator для приватного API';
        }
      }
    }

    document.getElementById('url').addEventListener('keypress', e => { if (e.key === 'Enter') go(); });
  </script>
</body>
</html>